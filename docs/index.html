<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R client utilities for interacting with the NeuronBridge matching service • neuronbridger</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="R client utilities for interacting with the NeuronBridge matching service">
<meta property="og:description" content="Use neuronbridge.org results in R for neuron matching across data sets. This will help users connect genetic reagents to experimentally target fly neurons with results from connectomics.">
<meta property="og:image" content="/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">neuronbridger</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/split_design.html">split GAL4 design</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/natverse/neuronbridger/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">


<div id="neuronbridger" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#neuronbridger" class="anchor"></a>neuronbridger</h1></div>
<p>The goal of <code>neuronbridger</code> is to provide R client utilities for interacting with the <a href="https://neuronbridge.janelia.org/">NeuronBridge</a> neuron matching service. This can help a user design sparse genetic driver lines for <em>D. melanogaster</em> neurons (i.e. <a href="https://www.janelia.org/lab/rubin-lab/our-research/gal4-driver-lines/split-gal4-lines">split-GAL4</a> lines) and discover what connectome-derived neuronal cell types are targetted by which extant genetic driver lines. This is becoming increasingly important as wet-lab biologists attempt to make sense of connectomic data <a href="https://doi.org/10.1016/j.conb.2018.12.012">(Bates et al. 2019)</a>.</p>
<p>The <a href="https://neuronbridge.janelia.org/">NeuronBridge website</a> provides and interface for loading and examining neuron matching results for <em>D. melanogaster</em> brains. Specifically, its aim is to enable one to search light (LM) and electron microscopy (EM) data sets of the <em>D. melanogaster</em> nervous system provided by the <a href="https://www.janelia.org/project-team/flylight">FlyLight</a> and <a href="https://www.janelia.org/project-team/flyem">FlyEM</a> projects at <a href="https://www.janelia.org/">Janelia Research Campus</a>.</p>
<p>You can find similar neurons based on shape regardless of data set. The <a href="https://neuronbridge.janelia.org/">NeuronBridge</a> tool was built by <a href="https://www.janelia.org/project-team/flylight">FlyLight</a> and scientific computing at <a href="https://www.janelia.org/">Janelia Research Campus</a>, see acknowledgements.</p>
<p>Using this R package in concert with the <a href="https://github.com/natverse/natverse">natverse</a> ecosystem is recommended. For example, the package <a href="https://github.com/jefferis/vfbr">vfbr</a> grants R side client utilities for <a href="https://v2.virtualflybrain.org/org.geppetto.frontend/geppetto">virtualflybrain.org</a>, allowing users to pull registered, fly brain confocal stacks for GAL4 lines. The package <a href="https://github.com/flyconnectome/hemibrainr">hemibrainr</a> contains more specific tools for annotations and analysis of the <a href="https://www.janelia.org/project-team/flyem/hemibrain">hemibrain connectome</a>.</p>
<div id="data-sets" class="section level2">
<h2 class="hasAnchor">
<a href="#data-sets" class="anchor"></a>Data sets</h2>
<p>The major EM dataset at the time when this package was built was the <a href="https://www.janelia.org/project-team/flyem/hemibrain">hemibrain connectome</a>. Connectome data can be seen using the <a href="https://neuprint.janelia.org/help/videos?dataset=hemibrain">neurPrint website</a> and accessed programmatically in R using <a href="https://github.com/natverse/neuprintr">neuprintr</a>.</p>
<p>Users of <a href="https://neuronbridge.janelia.org/">NeuronBridge</a> can discover which <a href="https://gen1mcfo.janelia.org/cgi-bin/gen1mcfo.cgi">Genaration 1 GAL4 lines</a> and <a href="https://splitgal4.janelia.org/cgi-bin/splitgal4.cgi">split-GAL4 lines</a> contain which hemibrain connectome neurons. GAL4 lines are genetic driver lines that can be used to express transgenes (e.g. flourescent proteins) in relatively small numbers of neurons in live flies. Linking them to results from the connectome enables researchers to experimentally manipulate components of the fly brain’s ‘wiring diagram’.</p>
</div>
<div id="how-have-these-searches-been-performed" class="section level2">
<h2 class="hasAnchor">
<a href="#how-have-these-searches-been-performed" class="anchor"></a>How have these searches been performed?</h2>
<p><a href="https://neuronbridge.janelia.org/">NeuronBridge</a> uses results from a ‘colour depth mask search’. The methodology has recently been published <a href="https://www.biorxiv.org/content/10.1101/318006v1">(Otsuna et al. 2018)</a>. This method represents 3d voxel space in a 2d image by encoding depth as colour, and allows for a fast pixel-based comparison across specimens. Both LM image volumes and EM reconstructions can be represented in this space, leading to efficient LM-&gt;EM and EM-&gt;LM searching.</p>
<p>Images are represented as colour ‘maximum intensity projection images’ (MIPs). A MIP is there not a ‘stack’ of images, but a single pane.</p>
<p>Here is an example of a MIP for a hemibrain neuron (<a href="https://neuprint.janelia.org/view?bodyid=542634818">542634818</a>, the DM1 olfactory uPN):</p>
<p><img src="https://raw.githubusercontent.com/natverse/neuronbridger/main/inst/images/mip_em_example.png" alt="mip_em_example"></p>
<p>And for a GAL4 lines that seems to contains that neuron (<a href="https://v2.virtualflybrain.org/org.geppetto.frontend/geppetto?id=VFBexp_FBtp0063448">R84D10</a>, data from stochastic labelling (MCFO) of line <a href="https://doi.org/10.1101/2020.05.29.080473">(Meissener et al. 2020)</a>):</p>
<p><img src="https://raw.githubusercontent.com/natverse/neuronbridger/main/inst/images/mip_gmr_example.png" alt="mip_gmr_example"></p>
<p><a href="https://neuronbridge.janelia.org/">NeuronBridge</a> loads precomputed matches between FlyLight Split GAL4 and MCFO vs Hemibrain 1.1. See its <a href="https://neuronbridge.janelia.org/releasenotes/NEURONBRIDGE">release notes</a> and <a href="https://neuronbridge.janelia.org/releasenotes/DATA">data version release notes</a>.</p>
<p>The data is also available on <a href="https://open.quiltdata.com/b/janelia-flylight-color-depth/tree">quilt</a>.</p>
<p><a href="https://github.com/natverse/nat.nblast">NBLAST</a> can also be used to match EM and LM neurons. However, it works best with ‘skeletonised’ neurons. Using ‘colour depth mask search’ circumvents this ‘skeletonisation’ step for both volumetric EM data and LM data. This step is still non-trivial. We have used NBLAST to match skeletons between two EM dataset, see: <a href="https://flyconnectome.github.io/hemibrainr/articles/match_making.html">neuron matching with hemibrainr</a>.</p>
</div>
<div id="why-would-i-need-to-look-at-these-results-in-r" class="section level2">
<h2 class="hasAnchor">
<a href="#why-would-i-need-to-look-at-these-results-in-r" class="anchor"></a>Why would I need to look at these results in R?</h2>
<p>The <a href="https://neuronbridge.janelia.org/">NeuronBridge website</a> is great for examining results. However, if we want to consider many neurons are once it is easiest to do so in an environment like R. A common goal these days is to use tools such as NeuronBridge to design ‘split-GAL4’ lines to sparsely target neurons of experimental interest to an investigator, ideally an individual cell type. A cell type may contain as little as 1-5 neurons on average <a href="https://pubmed.ncbi.nlm.nih.gov/30703584/">(Bates et al. 2019)</a>.</p>
<p>With <code>neuronbridger</code> one thing we can try to do is search for lines that are a hit for many neurons we want (e.g. all members of a cell type from the hemibrain connectome). Another, is to try to avoid lines that seem to contain neurons we do not want (e.g. similar looking hemibrain neurons, or common line contaminant you do not want, for some experimental reason). This could be critical for some experiments. Ultimately clean lines enable one to see neurons better during, for example, calcium imaging, or allow experimenters to only manipulate those cells when performing, for example, optogenetic behavioural experiments.</p>
</div>
</div>
<div id="tutorial" class="section level1">
<h1 class="hasAnchor">
<a href="#tutorial" class="anchor"></a>Tutorial</h1>
<p>Let us to grips with <code>neuronbridger</code>.</p>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://remotes.r-lib.org">"remotes"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span>
<span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"natverse/neuronbridger"</span><span class="op">)</span>

<span class="co"># use </span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/natverse/neuronbridger">neuronbridger</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="example" class="section level2">
<h2 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h2>
<p>Now we can have a look at what is available. Let us be interested in the hemibrain neuron 542634818, the DM1 uPN. This neuron is an olfactory projection neurons from the antennal lobe glomerulus ‘DM1’ and sends signals into deeper regions of the fly brain in response to odours in the fly’s environment, such as apple cider vinegar and other food-like smells.</p>
<div id="get-mip-information-for-a-connectome-neuron" class="section level3">
<h3 class="hasAnchor">
<a href="#get-mip-information-for-a-connectome-neuron" class="anchor"></a>Get MIP information for a connectome neuron</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># What neurons can be searched using NeuronBridge?</span>
<span class="va">all.nb.ids</span> <span class="op">=</span> <span class="fu"><a href="reference/neuronbridge_ids.html">neuronbridge_ids</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">neuronbridge_ids</span><span class="op">)</span>
<span class="co">## So there is over 36k neurons/lines that can be searched</span>

<span class="co"># I am interested in the hemibrain neuron, 542634818. </span>
<span class="co">## Do we have it?</span>
<span class="va">id</span> <span class="op">=</span> <span class="st">"542634818"</span>
<span class="va">id</span><span class="op">%in%</span><span class="va">all.nb.ids</span>
<span class="co">## Yes!</span>

<span class="co"># What do we have on it?</span>
<span class="va">nb.info</span> <span class="op">=</span> <span class="fu"><a href="reference/neuronbridge_info.html">neuronbridge_info</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/View.html">View</a></span><span class="op">(</span><span class="va">nb.info</span><span class="op">)</span>
<span class="co">## So here you see one entry because only one MIP file matches the given ID</span>
<span class="co">## In some cases, esp. for GAL4 line, there may be multiple entries because multiple images for stochastic labelling have been taken.</span>
<span class="co">## In this data frame, you find interesting fields such as the dataset the ID if from (libraryName), the locations at which NeuronBridge saves</span>
<span class="co">## MIP files related to this neuron, the gender of the fly brain from which this data item came.</span>
<span class="co">## Importantly there is an internal NeuronBridge ID for this data item (nb.id, 2820604089967050763).</span>
<span class="co">## Every MIP has its own nb.id because multiple MIPs could relate to the same GAL4 line.</span>
<span class="co">## see ?neuronbridge_info</span>

<span class="co"># Let us now see the related MIP file</span>
<span class="va">dm1.mip</span> <span class="op">=</span> <span class="fu"><a href="reference/neuronbridge_mip.html">neuronbridge_mip</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span>
<span class="co">## This gets every MIP file associated with id</span>

<span class="co"># Plot the MIP image in an rgl viewer</span>
<span class="fu"><a href="reference/neuronbridge_mip.html">plot_mip</a></span><span class="op">(</span><span class="va">dm1.mip</span><span class="op">)</span></code></pre></div>
</div>
<div id="searching-for-hits-among-genetic-driver-lines" class="section level3">
<h3 class="hasAnchor">
<a href="#searching-for-hits-among-genetic-driver-lines" class="anchor"></a>Searching for ‘hits’ among genetic driver lines</h3>
<p>Now that we know that our hemibrain connectome neuron, the DM1 uPN (542634818), is in the NeuronBridge database, and we have seen its colour MIP, we may want to know what its matches are. Let us go for it:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># In order to look for hits, we need the nb.id not the id</span>
<span class="co">## Why? Well in this case it is moot, but for some data items, i..e GAL4 liens rather than hemibrain neurons, there are multiple MIP files</span>
<span class="co">## Each one may be from a different MCFO experiment, i.e. a different random subset of neurons contained in the full line.</span>
<span class="co">## The id would specify all of these files. The nb.id specifies just the one with which you wish to search.</span>
<span class="va">nb.id</span> <span class="op">=</span> <span class="va">nb.info</span><span class="op">$</span><span class="va">nb.id</span>
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">nb.id</span><span class="op">)</span>
<span class="co"># We just have one</span>

<span class="co"># Find information on hits</span>
<span class="va">nb.hits</span> <span class="op">=</span> <span class="fu"><a href="reference/neuronbridge_hits.html">neuronbridge_hits</a></span><span class="op">(</span>nb.id<span class="op">=</span><span class="va">nb.id</span><span class="op">)</span>
<span class="co">## This data frame is already ranked so that the top hits are at the top.</span>

<span class="co"># We can see the top 10 hits</span>
<span class="fu"><a href="https://rdrr.io/r/utils/View.html">View</a></span><span class="op">(</span><span class="va">nb.hits</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="op">]</span><span class="op">)</span>
<span class="co">## Looks like the Gen1 GMR GAL4 lines R84D10 and R26B04 target the DM1 uPN.</span>
<span class="co">## We could design a split-GAL4 lien using hemidrivers from these lines.</span>
<span class="co">## Though they are likely to also give us similar looking PNs that are not</span>
<span class="co">## the DM1 uPN, in addition to the DM1 uPN ....</span>

<span class="co"># We can take a quick look at the score distribution</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">nb.hits</span><span class="op">$</span><span class="va">normalizedScore</span><span class="op">)</span>
<span class="co">## As expected, most lines are not going to contain our neuron!</span>

<span class="co"># Let us scan through our top 10 hits and see what they look like</span>
<span class="fu"><a href="reference/neuronbridge_mip.html">scan_mip</a></span><span class="op">(</span>mips <span class="op">=</span> <span class="va">nb.hits</span>, no.hits <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>

<span class="co"># Good, some nice looking possibilities there.</span>
<span class="co">## We have saved a lot of MIP files in our local directory.</span>
<span class="co">## Which is good if we wish to keep accessing them, but we can clear with:</span>
<span class="fu"><a href="reference/neuronbridge_mip.html">neuronbridge_remove_mips</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># This said, best practice would be to set the option 'neuronbridger' to a location</span>
<span class="co">## on your computer, where MIP files cna be downloaded and view at your leisure. I.e.</span>
<span class="co"># options(neuronbridger="PATH/TO/MY/MIPS")</span></code></pre></div>
</div>
<div id="filtering-for-the-best-hits" class="section level3">
<h3 class="hasAnchor">
<a href="#filtering-for-the-best-hits" class="anchor"></a>Filtering for the best hits</h3>
<p>However, there are a lot of neurons that look like the DM1 uPNs. In fact, we can see a load of them like this:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/flyconnectome/hemibrainr">"hemibrainr"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"flyconnectome/hemibrainr"</span><span class="op">)</span>

<span class="co"># Load package to examine hemibrain data</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/natverse/neuprintr">neuprintr</a></span><span class="op">)</span>

<span class="co"># Get all olfactory PNs</span>
<span class="va">all.pns</span> <span class="op">=</span> <span class="fu">neuprintr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/neuprintr/man/neuprint_read_neurons.html">neuprint_read_neurons</a></span><span class="op">(</span><span class="fu">hemibrainr</span><span class="fu">::</span><span class="va"><a href="https://flyconnectome.github.io/hemibrainr/reference/classed.ids.html">pn.ids</a></span><span class="op">)</span>
<span class="co">## There's a lot of neurons to grab, it might take a while</span>

<span class="co"># Now plot!</span>
<span class="fu">nat</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nat/man/nopen3d.html">nopen3d</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu">hemibrainr</span><span class="fu">::</span><span class="fu"><a href="https://flyconnectome.github.io/hemibrainr/reference/hemibrain_view.html">hemibrain_view</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu">plot3d</span><span class="op">(</span><span class="va">all.pns</span><span class="op">[</span><span class="va">id</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"black"</span>, lwd <span class="op">=</span> <span class="fl">5</span>, soma <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="co"># in black, the DM1 uPN</span>
<span class="fu">plot3d</span><span class="op">(</span><span class="va">all.pns</span>, soma <span class="op">=</span> <span class="fl">500</span>, lwd <span class="op">=</span> <span class="fl">0.5</span>, alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span>

<span class="co"># See the problem?</span>
<span class="co">## These are all different neurons, and many different neuron types. There is only oneDM1 uPN. </span>
<span class="co">## However, there is a lot that looks similar that might also be labelled by the same lines.</span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/natverse/neuronbridger/main/inst/images/em_dm1_upn.png" alt="em_dm1_upn"></p>
<p>So how can we make sure we only get the PN we want, and not these other PNs?</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># So this is the one we want</span>
<span class="va">search</span> <span class="op">=</span> <span class="st">"542634818"</span>

<span class="co"># And we do not want these other PNs</span>
<span class="va">avoid</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="fu">hemibrainr</span><span class="fu">::</span><span class="va"><a href="https://flyconnectome.github.io/hemibrainr/reference/classed.ids.html">pn.ids</a></span>,<span class="va">search</span><span class="op">)</span>

<span class="co"># Search! ASnd get info on those neurons we do not like as well.</span>
<span class="va">nb.a</span> <span class="op">=</span> <span class="fu"><a href="reference/neuronbridge_avoid.html">neuronbridge_avoid</a></span><span class="op">(</span>search <span class="op">=</span> <span class="va">search</span>, avoid <span class="op">=</span> <span class="va">avoid</span><span class="op">)</span>
<span class="co">## This may take a long time as 'avoid' has many IDs</span>
<span class="co">### Luckily, we have a loading bar!</span>

<span class="co"># Examine the results</span>
<span class="fu"><a href="https://rdrr.io/r/utils/View.html">View</a></span><span class="op">(</span><span class="va">nb.a</span><span class="op">)</span>
<span class="co">## A lot of our top hits have neurons we would rather not have huh</span></code></pre></div>
</div>
<div id="which-connectome-neurons-are-inside-each-genetic-driver-line" class="section level3">
<h3 class="hasAnchor">
<a href="#which-connectome-neurons-are-inside-each-genetic-driver-line" class="anchor"></a>Which connectome neurons are inside each genetic driver line?</h3>
<p>We may also want to predict which neurons are in a given genetic driver line. Let us consider the case of MB543B, a generation 1 GMR line that is pretty ‘sparse’ and seems to label neurons from the mushroom body <a href="https://elifesciences.org/articles/04577">(Aso et al., 2014)</a>. There are 5 ‘MCFO’ images for this neuron. This means that the FlyLight team has stochastically labelled a subset of neurons in this line five times <a href="https://doi.org/10.1101/2020.05.29.080473">(Meissener et al. 2020)</a>. Each time they took a confocal stack, which was later converted into a colour MIP. We can examine the ‘MIP search matches’ for each of these images to try to determine the ‘contents’ of this line i.e. which neurons from the hemibrain connectome it might target.</p>
<p>These are the individual MIPs for different MCFO experiments for the GAL4 line MB543B:</p>
<p><img width="800" alt="MB543B#1" src="https://raw.githubusercontent.com/natverse/neuronbridger/main/inst/images/MB543B_1.png"><br><img width="800" alt="MB543B#2" src="https://raw.githubusercontent.com/natverse/neuronbridger/main/inst/images/MB543B_2.png"><img width="800" alt="MB543B#3" src="https://raw.githubusercontent.com/natverse/neuronbridger/main/inst/images/MB543B_3.png"><img width="800" alt="MB543B#4" src="https://raw.githubusercontent.com/natverse/neuronbridger/main/inst/images/MB543B_4.png"><img width="800" alt="MB543B#5" src="https://raw.githubusercontent.com/natverse/neuronbridger/main/inst/images/MB543B_5.png"></p>
<p>Let us see which connectome neurons have high matching scores:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Interesting line that labels mushroom body neurons</span>
<span class="co">## But which ones?</span>
<span class="va">line</span> <span class="op">=</span> <span class="st">"MB543B"</span>

<span class="co"># Let's find out</span>
<span class="va">contents</span> <span class="op">=</span> <span class="fu"><a href="reference/neuronbridge_line_contents.html">neuronbridge_line_contents</a></span><span class="op">(</span>line <span class="op">=</span> <span class="va">line</span>, threshold <span class="op">=</span> <span class="fl">23000</span><span class="op">)</span>
<span class="co">## Note! Choosing the right threshold for the nomarlsied MIP-comparison score</span>
<span class="co">### Is critical. This may take some titring for lines you are really interested in</span>
<span class="co">#### Though this value is a good first pass.</span>

<span class="co"># So this is what is likely in this line!</span>
<span class="co">## Note we have meta-data from neuprint! So we can see neuron types and names!!</span>
<span class="fu"><a href="https://rdrr.io/r/utils/View.html">View</a></span><span class="op">(</span><span class="va">contents</span><span class="op">)</span>

<span class="co"># Now let's check what these neurons look like</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/natverse/neuprintr">"neuprintr"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"natverse/neuprintr"</span><span class="op">)</span>

<span class="co"># Load package</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/natverse/neuprintr">neuprintr</a></span><span class="op">)</span>
<span class="co">## Note you need to 'login' to neuPrint through R</span>
<span class="co">### Look at the package README and/or examine: ?neuprint_login</span>

<span class="co"># Let's see the EM neurons all together</span>
<span class="va">cont.neurons</span> <span class="op">=</span> <span class="fu">neuprintr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/neuprintr/man/neuprint_read_neurons.html">neuprint_read_neurons</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">contents</span><span class="op">$</span><span class="va">publishedName</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Plot in 3d!</span>
<span class="fu">hemibrainr</span><span class="fu">::</span><span class="fu"><a href="https://flyconnectome.github.io/hemibrainr/reference/hemibrain_view.html">hemibrain_view</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu">plot3d</span><span class="op">(</span><span class="va">cont.neurons</span>, lwd  <span class="op">=</span> <span class="fl">2</span>, soma <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>
<span class="fu">plot3d</span><span class="op">(</span><span class="fu">hemibrainr</span><span class="fu">::</span><span class="va"><a href="https://flyconnectome.github.io/hemibrainr/reference/hemibrain.surf.html">hemibrain.surf</a></span>, col <span class="op">=</span> <span class="st">"grey"</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>

<span class="co"># And compare with the LM data:</span>
<span class="fu">open3d</span><span class="op">(</span><span class="op">)</span>
<span class="va">mips</span> <span class="op">=</span> <span class="fu"><a href="reference/neuronbridge_mip.html">neuronbridge_mip</a></span><span class="op">(</span><span class="va">line</span><span class="op">)</span>
<span class="fu"><a href="reference/neuronbridge_mip.html">scan_mip</a></span><span class="op">(</span><span class="va">mips</span>,type<span class="op">=</span><span class="st">"images"</span>, sleep <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></code></pre></div>
<p><img src="https://raw.githubusercontent.com/natverse/neuronbridger/main/inst/images/em_hits.png" alt="em_hits"></p>
<p>We can use this to try to work out how to design a ‘split’ line. The split-GAL4 method allows an experimenter to ‘intersect’ the expression of two GAL4 lines, and in so doing produce a ‘split-GAL4’ line that only targets those neurons in both patterns. Note that some MIPs in the NeuronBridge database already represent split-GAL4 line.</p>
<p>So returning to our DM1 uPN issue, let’s see what we might hope to get from combining the GAL4 lines that appear to be our bets hit:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Based on the results above</span>
<span class="va">line1</span> <span class="op">=</span> <span class="st">"R84D10"</span> <span class="co"># this line seems to be the top hit for the EM DM1 uPN</span>
<span class="va">line2</span> <span class="op">=</span> <span class="st">"VT033006"</span> <span class="co"># this is not the secodn highest, but has fewer of the neurons we do not like if we inspect nb.a above.</span>

<span class="co"># What neurons might we expect?</span>
<span class="va">potential.split</span> <span class="op">=</span> <span class="fu"><a href="reference/neuronbridge_line_contents.html">neuronbridge_predict_split</a></span><span class="op">(</span>line1 <span class="op">=</span> <span class="va">line1</span>, line2 <span class="op">=</span> <span class="va">line2</span>,
                                             threshold1 <span class="op">=</span> <span class="fl">23000</span>, threshold2 <span class="op">=</span> <span class="fl">23000</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"Potentially ~"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">potential.split</span><span class="op">)</span>, <span class="st">" neurons in this predicted split"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/View.html">View</a></span><span class="op">(</span><span class="va">potential.split</span><span class="op">)</span></code></pre></div>
</div>
<div id="conclusions" class="section level3">
<h3 class="hasAnchor">
<a href="#conclusions" class="anchor"></a>Conclusions</h3>
<p>Bear in mind that this function and some others are very sensitive to the value you give the threshold argument!! You will have to empirically determine a good value for this - it might differ given the kind of neurons you are looking at for example.</p>
<p>Of course - do not go planning any experiments based on the results of this package without looking at the 3D stacks for GAL4 lines first! The results from these functions are only as good as the LM-EM matching scores from the colour MIP searches performed by FlyLight. In addition, the more stochastic labelling (MCFO) that has been performed on a line, the more certain we can be of its contents - but many lines need a lot more MCFO.</p>
</div>
</div>
</div>
<div id="acknowledgments" class="section level1">
<h1 class="hasAnchor">
<a href="#acknowledgments" class="anchor"></a>Acknowledgments</h1>
<div id="data-and-tools" class="section level2">
<h2 class="hasAnchor">
<a href="#data-and-tools" class="anchor"></a>Data and tools</h2>
<p><a href="https://neuronbridge.janelia.org/">NeuronBridge</a> was developed by scientific advisors (Geoffrey Meissner, Wyatt Korff, Gudrun Ihrke), data scientists (Hideo Otsuna) and software developers (Jody Clements, Cristian Goina, Rob Svirskas, Konrad Rokicki, Antje Kazimiers) at <a href="https://www.janelia.org/">Janelia Research Campus</a>.</p>
<p>Please examine the <a href="https://neuronbridge.janelia.org/usage">NeuronBridge usage terms</a>. If you use results from this package, you should cite this package, <a href="https://janelia.figshare.com/articles/NeuronBridge_Codebase/12159378/1">Clements et al. 2020</a> for the NeuronBridge codebase, <a href="https://www.biorxiv.org/content/10.1101/318006v1">Ostsuna et al. 2018</a> for the methodology, and the <a href="https://neuronbridge.janelia.org/usage">relevant publications</a> for any data sets used. See below.</p>
<p>This package was created by <a href="https://scholar.google.com/citations?user=BOVTiXIAAAAJ&amp;hl=en">Alexander Shakeel Bates</a> while in the group of <a href="https://neuro.hms.harvard.edu/faculty-staff/rachel-wilson">Rachel Wilson</a>. Note the package version mirrors the <a href="(https://neuronbridge.janelia.org/releasenotes/DATA)">version of NeuronBridge data</a> it was made to work with. You can cite this package as:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/citation.html">citation</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"neuronbridger"</span><span class="op">)</span></code></pre></div>
<p><strong>Bates AS</strong> (2020). <em>neuronbridger: R client utilities for interacting with the neuronbridge matching service.</em> <strong>R package</strong> version 2.1.1. <a href="https://github.com/natverse/neuronbridger" class="uri">https://github.com/natverse/neuronbridger</a></p>
</div>
<div id="citations" class="section level2">
<h2 class="hasAnchor">
<a href="#citations" class="anchor"></a>Citations</h2>
<ul>
<li><p><strong>The hemibrain connectome (hemibrain:v1.1)</strong>: Scheffer, L.K., Xu, C.S., Januszewski, M., Lu, Z., Takemura, S.-Y., Hayworth, K.J., Huang, G.B., Shinomiya, K., Maitlin-Shepard, J., Berg, S., et al. (2020). A connectome and analysis of the adult Drosophila central brain. Elife 9. <a href="https://doi.org/10.1101/2020.05.29.080473">doi: https://doi.org/10.1101/2020.05.29.080473</a></p></li>
<li><p><strong>Gen 1 GAL4 line MCFO</strong>: Meissner, G.W., Dorman, Z., Nern, A., Forster, K., Gibney, T., Jeter, J., Johnson, L., He, Y., Lee, K., Melton, B., et al. (2020). An image resource of subdivided Drosophila GAL4-driver expression patterns for neuron-level searches. bioRxiv. <a href="https://doi.org/10.1101/2020.05.29.080473">doi: https://doi.org/10.1101/2020.05.29.080473</a></p></li>
<li><p><strong>Gen 1 VT GAL4 lines and hemidrivers</strong>: Tirian, L., and Dickson, B. (2017). The VT GAL4, LexA, and split-GAL4 driver line collections for targeted expression in the Drosophila nervous system. bioRxiv. <a href="https://doi.org/10.1101/198648">doi: https://doi.org/10.1101/198648</a></p></li>
<li><p><strong>Gen 1 GMR GAL4 lines</strong>: Jenett, A., Rubin, G.M., Ngo, T.-T.B., Shepherd, D., Murphy, C., Dionne, H., Pfeiffer, B.D., Cavallaro, A., Hall, D., Jeter, J., et al. (2012). A GAL4-Driver Line Resource for Drosophila Neurobiology. Cell Rep. 2, 991–1001. <a href="https://doi.org/10.1016/j.celrep.2012.09.011">doi: https://doi.org/10.1016/j.celrep.2012.09.011</a></p></li>
<li><p><strong>GMR hemidrivers</strong>: Dionne, H., Hibbard, K.L., Cavallaro, A., Kao, J.-C., and Rubin, G.M. (2018). Genetic Reagents for Making Split-GAL4 Lines in Drosophila. Genetics 209, 31–35. <a href="https://doi.org/10.1534/genetics.118.300682">doi :https://doi.org/10.1534/genetics.118.300682</a></p></li>
<li><p><strong>JRC2018F brain and VNS templates</strong>: Bogovic, J.A., Otsuna, H., Heinrich, L., Ito, M., Jeter, J., Meissner, G.W., Nern, A., Colonell, J., Malkesman, O., Ito, K., et al. (2018). An unbiased template of the Drosophila brain and ventral nerve cord. bioRxiv. <a href="https://doi.org/10.1101/376384">doi: https://doi.org/10.1101/376384</a></p></li>
<li><p><strong>Colour MIP search tool</strong>: Otsuna, H., Ito, M., and Kawase, T. (2018). Color depth MIP mask search: a new tool to expedite Split-GAL4 creation. bioRxiv. <a href="https://doi.org/10.1101/318006">doi: https://doi.org/10.1101/318006</a></p></li>
<li><p><strong>NeuronBridge codebase</strong>: Clements, J., Goina, C., Kazimiers A., Otsuna, H., Svirskas, R., Rokicki K. (2020) NeuronBridge Codebase. <a href="https://janelia.figshare.com/articles/NeuronBridge_Codebase/12159378/1">software</a></p></li>
<li><p><strong>Janelia split-GAL4 lines</strong>: <a href="https://neuronbridge.janelia.org/about">various</a></p></li>
<li><p><strong>What is a fly brain cell type</strong>: Bates, A.S., Janssens, J., Jefferis, G.S., and Aerts, S. (2019). Neuronal cell types in the fly: single-cell anatomy meets single-cell genomics. Curr. Opin. Neurobiol. 56, 125–134. <a href="https://doi.org/10.1016/j.conb.2018.12.012">doi: https://doi.org/10.1016/j.conb.2018.12.012</a></p></li>
</ul>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Browse source code at <br><a href="https://github.com/natverse/neuronbridger/">https://​github.com/​natverse/​neuronbridger/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/natverse/neuronbridger/issues">https://​github.com/​natverse/​neuronbridger/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Alexander Bates <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-1195-0445" target="orcid.widget" aria-label="ORCID"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://natverse.github.io"><img src="https://img.shields.io/badge/natverse-Part%20of%20the%20natverse-a241b6" alt="natverse"></a></li>
<li><a href="http://natverse.github.io/neuronbridger/reference/"><img src="https://img.shields.io/badge/docs-100%25-brightgreen.svg" alt="Docs"></a></li>
<li><a href="https://travis-ci.com/natverse/neuronbridger"><img src="https://travis-ci.com/natverse/neuronbridger.svg?branch=main" alt="Travis build status"></a></li>
<li><a href="https://codecov.io/gh/natverse/neuronbridger?branch=main"><img src="https://codecov.io/gh/natverse/neuronbridger/branch/main/graph/badge.svg" alt="Codecov test coverage"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Alexander Bates.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
